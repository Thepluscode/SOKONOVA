name: CI - Continuous Integration

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # Backend CI Job
  # ============================================
  backend-ci:
    name: Backend - Test & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: sokonova_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Lint code
        run: npm run lint --if-present || echo "No lint script found"

      - name: üî® Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/sokonova_test

      - name: üóÉÔ∏è Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/sokonova_test

      - name: üß™ Run tests with coverage
        run: npm test -- --coverage --verbose
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/sokonova_test
          JWT_SECRET: test_jwt_secret_for_ci_only_min_32_chars_long
          NODE_ENV: test

      - name: üìä Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./backend/coverage/coverage-final.json
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
        continue-on-error: true

      - name: üîé Type check
        run: npx tsc --noEmit

      - name: üèóÔ∏è Build application
        run: npm run build
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/sokonova_test

      - name: ‚úÖ Build artifacts check
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/main.js" ]; then
            echo "‚ùå Build failed: main.js not found in dist"
            exit 1
          fi
          echo "‚úÖ Build successful: dist/main.js exists"

  # ============================================
  # Frontend CI Job
  # ============================================
  frontend-ci:
    name: Frontend - Test & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./sokonova-frontend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: sokonova-frontend/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Lint code
        run: npm run lint --if-present || echo "No lint script found"

      - name: üîé Type check
        run: npx tsc --noEmit || echo "No TypeScript check configured"

      - name: üß™ Run tests
        run: npm test --if-present || echo "No tests configured yet"

      - name: üèóÔ∏è Build application
        run: npm run build
        env:
          VITE_API_URL: https://api.sokonova.com
          VITE_WS_URL: wss://api.sokonova.com

      - name: ‚úÖ Build artifacts check
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist directory not found"
            exit 1
          fi
          echo "‚úÖ Build successful: dist directory exists"

  # ============================================
  # Security Audit Job
  # ============================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üîí Audit backend dependencies
        run: |
          cd backend
          npm audit --audit-level=moderate || true
          echo "Checking for critical vulnerabilities..."
          npm audit --audit-level=critical

      - name: üîí Audit frontend dependencies
        run: |
          cd sokonova-frontend
          npm audit --audit-level=moderate || true
          echo "Checking for critical vulnerabilities..."
          npm audit --audit-level=critical

  # ============================================
  # Environment Validation Job
  # ============================================
  env-validation:
    name: Environment Validation
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚úÖ Check .env.example files exist
        run: |
          if [ ! -f "backend/.env.example" ]; then
            echo "‚ùå backend/.env.example is missing"
            exit 1
          fi
          if [ ! -f "backend/.env.production.example" ]; then
            echo "‚ùå backend/.env.production.example is missing"
            exit 1
          fi
          echo "‚úÖ All environment example files present"

      - name: ‚úÖ Verify no .env files in git
        run: |
          if git ls-files | grep -E "\.env$|\.env\.local$|\.env\.production$"; then
            echo "‚ùå ERROR: .env files should not be committed to git!"
            echo "Found the following .env files:"
            git ls-files | grep -E "\.env$|\.env\.local$|\.env\.production$"
            exit 1
          fi
          echo "‚úÖ No .env files committed (good!)"

      - name: ‚úÖ Check for exposed secrets
        run: |
          if git log --all --oneline | grep -iE "password|secret|key" | head -5; then
            echo "‚ö†Ô∏è  WARNING: Commit messages contain sensitive keywords"
            echo "This doesn't necessarily mean secrets are exposed, but review carefully"
          fi
          echo "‚úÖ Secret exposure check complete"

  # ============================================
  # Summary Job
  # ============================================
  ci-summary:
    name: CI Summary
    needs: [backend-ci, frontend-ci, security-audit, env-validation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: üìä Check all jobs status
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend CI | ${{ needs.backend-ci.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend CI | ${{ needs.frontend-ci.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security-audit.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è  Warning' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Env Validation | ${{ needs.env-validation.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Fail if any critical job failed
        if: needs.backend-ci.result == 'failure' || needs.frontend-ci.result == 'failure' || needs.env-validation.result == 'failure'
        run: |
          echo "‚ùå CI Pipeline failed - check individual jobs for details"
          exit 1

      - name: ‚úÖ All checks passed
        if: needs.backend-ci.result == 'success' && needs.frontend-ci.result == 'success'
        run: |
          echo "‚úÖ All CI checks passed successfully!"
          echo "Ready to deploy to production"
